---
title: "Proyecto predicción de precios en viviendas"
output: html_notebook
---

Importación y carga de paquetes

```{r}
library(tidyverse)
library(caret)
library(data.table)
library(ggplot2)
library(dplyr)
library(corrplot)
library(psych)
```


Carga de los datos (Tarea 0)

```{r}
train_df <- read_csv('./data/train.csv')
test_df <- read_csv('./data/test.csv')

```

#Visualización de los datos

Vamos a observar las primeras entradas de nuestro conjunto de datos para conocer un poco más de información sobre
el dataset.

```{r}
train_df %>% head()
```

Número de filas y columnas del conjunto de entrenamiento.
```{r}
nrow(train_df)
ncol(train_df)
```

Número de filas y columnas del conjunto de prueba.
```{r}
nrow(test_df)
ncol(test_df)
```

##Preprocesamiento.

#Eliminación de atributos con más de un 10% de entradas con valor NA. (Tarea 1)

Primero obtendremos una tabla que nos muestre cuantos valores NA existen para cada columna.
```{r}
na_count <- sapply(train_df, function(y) sum((is.na(y))))
na_count <- data.frame(na_count)
```

Ahora procederemos a eliminar las columnas que tengan más de un 10% de entradas con valor NA

```{r}
columns_na <- na_count %>% filter((na_count/nrow(train_df)*100) > 10) %>% rownames()
```

Por último, eliminaremos estas columnas tanto de nuestro conjunto de entrenamiento como en el de prueba.

```{r}
train_df <- train_df[,!(names(train_df) %in% columns_na)]
test_df <- test_df[,!(names(test_df) %in% columns_na)]
```
#Rellenar campos con valor NA. (Tarea 3)

Para todos los valores NA restantes, los modificaremos por las valores más frecuentes o con la media.

```{r}
na_modified <- function(x) {
  if (is.numeric(x)) {
    x[is.na(x)] <- mean(x, na.rm = TRUE)
    x
  } else {
    x[is.na(x)] <- names(which.max(table(x)))
    x
  }
}

train_df <- as.data.frame(lapply(train_df,na_modified))
test_df <- as.data.frame(lapply(test_df,na_modified))
```

## Eliminación de variables no relevantes mediante correlación (Tarea 12)

### NUMÉRICAS

```{r}
train_df_nums <- select_if(train_df, is.numeric)
```
Eliminación de NAs, este bloque debería sobrar cuando el limpiado esté completo
```{r}
train_df_nums <- subset( train_df_nums, select = -c(LotFrontage, MasVnrArea, GarageYrBlt))
```

```{r}

train_cor <- cor(train_df_nums[ , colnames(train_df_nums) != "SalePrice"],
                train_df_nums$SalePrice)
```

```{r}
corrplot(train_cor,
         cl.pos='n',
         insig = 'p-value')
```
```{r}
cor_coef_df <- as.data.frame(train_cor) %>% 
    rename('abs_cor_coef' = V1) %>%
    mutate(abs_cor_coef = abs(abs_cor_coef))
cor_coef_df
```
```{r}
drop_columns_less_20 <- cor_coef_df   %>% filter(abs_cor_coef <0.2)
drop_columns_less_20
```
```{r}
#bigger_threshold <- cor_coef_df > 0.2
bigger_threshold <- replace(cor_coef_df, cor_coef_df<0.2, "red")
bigger_threshold <- replace(bigger_threshold, cor_coef_df>0.2, "green")
bigger_threshold[,1]
```

```{r}
col_names <- row.names(cor_coef_df)
```

```{r}
df <- as.data.frame(cor_coef_df)
```


```{r}
ggplot(df
       , aes(x=col_names, y=abs_cor_coef, fill = col_names)
       ) + 
  scale_fill_manual(
    breaks = c(col_names),
    values=c(bigger_threshold[,1])) +
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(angle = 70, vjust = 0.85, hjust=1))
```


```{r}
train_df <- subset( train_df, select = -drop_columns_less_20 )
```


Eliminación de variables que no aportan información al algoritmo (Tarea 5)

## IMPORTANTE
  Eliminar esta columna al finalizar el preprocesado, antes puede servir para algunas operaciones a la hora de partir y unir datasets.

```{r}
train_df <- subset( train_df, select = -Id )
test_df <- subset( test_df, select = -Id )
```

